AWSTemplateFormatVersion: 2010-09-09
Description: '''This SAM template creates the management API for the container platform.
  Last Modified: July 3rd 2019 Author: Karl Wallbom <wallbomk@amazon.com''

  '
Globals:
  Api:
    EndpointConfiguration: REGIONAL
  Function:
    Environment:
      Variables:
        PLATFORM_BUCKET:
          Ref: ProductsBucket
        PLATFORM_DEPLOYMENT_ROLE:
          Fn::GetAtt:
          - DeploymentRole
          - Arn
        PLATFORM_PREFIX:
          Fn::Sub: ${PlatformPrefix}-
        PLATFORM_REGION:
          Ref: AWS::Region
    Handler: index.handler
    Runtime: python3.7
    Timeout: 180
Parameters:
  PlatformPrefix:
    Default: gureume
    Description: String to use as prefix for platform resources
    Type: String
Resources:
  APIGatewayProdEndpointParam:
    Properties:
      Description: API Endpoint for the API.
      Name: /gureume/api/api-endpoint
      Type: String
      Value:
        Fn::Sub: https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/v1/
    Type: AWS::SSM::Parameter
  ApiGatewayApi:
    Properties:
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: s3://storage-kalleh/d9ae950ccb2a95bec578805d941bae61
      StageName: v1
    Type: AWS::Serverless::Api
  CognitoAppClientIDParam:
    Properties:
      Description: Cognito App Client ID to be used by clients.
      Name: /gureume/api/cognito-app-client-id
      Type: String
      Value:
        Ref: UserPoolClient
    Type: AWS::SSM::Parameter
  CognitoAuthorizedRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRoleWithWebIdentity
          Condition:
            ForAnyValue:StringLike:
              cognito-identity.amazonaws.com:amr: authenticated
            StringEquals:
              cognito-identity.amazonaws.com:aud:
                Ref: IdentityPool
          Effect: Allow
          Principal:
            Federated: cognito-identity.amazonaws.com
        Version: '2012-10-17'
      Policies:
      - PolicyDocument:
          Statement:
          - Action:
            - mobileanalytics:PutEvents
            - cognito-sync:BulkPublish
            - cognito-sync:DescribeIdentityPoolUsage
            - cognito-sync:GetBulkPublishDetails
            - cognito-sync:GetCognitoEvents
            - cognito-sync:GetIdentityPoolConfiguration
            - cognito-sync:ListIdentityPoolUsage
            - cognito-sync:SetCognitoEvents
            - congito-sync:SetIdentityPoolConfiguration
            - cognito-identity:DeleteIdentityPool
            - cognito-identity:DescribeIdentityPool
            - cognito-identity:GetIdentityPoolRoles
            - cognito-identity:GetOpenIdTokenForDeveloperIdentity
            - cognito-identity:ListIdentities
            - cognito-identity:LookupDeveloperIdentity
            - cognito-identity:MergeDeveloperIdentities
            - cognito-identity:UnlikeDeveloperIdentity
            - cognito-identity:UpdateIdentityPool
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:cognito-identity:${AWS::Region}:${AWS::AccountId}:identitypool/${IdentityPool}
          Version: '2012-10-17'
        PolicyName: CognitoAuthorizedPolicy
    Type: AWS::IAM::Role
  CognitoESAccessRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service: es.amazonaws.com
        Version: '2012-10-17'
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AmazonESCognitoAccess
    Type: AWS::IAM::Role
  CognitoIdentityPoolIDParam:
    Properties:
      Description: Cognito User Pool ID to be used by clients.
      Name: /gureume/api/cognito-identity-pool-id
      Type: String
      Value:
        Ref: IdentityPool
    Type: AWS::SSM::Parameter
  CognitoUnAuthorizedRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRoleWithWebIdentity
          Condition:
            ForAnyValue:StringLike:
              cognito-identity.amazonaws.com:amr: unauthenticated
            StringEquals:
              cognito-identity.amazonaws.com:aud:
                Ref: IdentityPool
          Effect: Allow
          Principal:
            Federated: cognito-identity.amazonaws.com
        Version: '2012-10-17'
      Policies:
      - PolicyDocument:
          Statement:
          - Action:
            - mobileanalytics:PutEvents
            - cognito-sync:BulkPublish
            - cognito-sync:DescribeIdentityPoolUsage
            - cognito-sync:GetBulkPublishDetails
            - cognito-sync:GetCognitoEvents
            - cognito-sync:GetIdentityPoolConfiguration
            - cognito-sync:ListIdentityPoolUsage
            - cognito-sync:SetCognitoEvents
            - congito-sync:SetIdentityPoolConfiguration
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:cognito-identity:${AWS::Region}:${AWS::AccountId}:identitypool/${IdentityPool}
          Version: '2012-10-17'
        PolicyName: CognitoUnauthorizedPolicy
    Type: AWS::IAM::Role
  CognitoUserPoolIDParam:
    Properties:
      Description: Cognito User Pool ID to be used by clients.
      Name: /gureume/api/cognito-user-pool-id
      Type: String
      Value:
        Ref: UserPool
    Type: AWS::SSM::Parameter
  CreateApp:
    Properties:
      CodeUri: s3://storage-kalleh/0a8f0b2b02a69c880ef6678d0a03312f
      Events:
        CreateApp:
          Properties:
            Method: post
            Path: /apps
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: create_app.post
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:CreateStack
          - cloudformation:ListExports
          - elasticloadbalancing:DescribeRules
          - iam:PassRole
          - ssm:GetParametersByPath
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  CreatePipeline:
    Properties:
      CodeUri: s3://storage-kalleh/e0eb4ec602bd97df4a9ee8ed99c7a253
      Events:
        CreatePipeline:
          Properties:
            Method: post
            Path: /pipelines
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: create_pipeline.post
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:CreateStack
          - cloudformation:ListExports
          - iam:PassRole
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  CreateService:
    Properties:
      CodeUri: s3://storage-kalleh/2e341ea17ea92ece7e11f3787ce55b5d
      Events:
        CreateService:
          Properties:
            Method: post
            Path: /services
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: create_service.post
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:CreateStack
          - cloudformation:ListExports
          - iam:PassRole
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  DeleteApp:
    Properties:
      CodeUri: s3://storage-kalleh/d96fc9727eca29d1b62c83ddca181793
      Events:
        DeleteApp:
          Properties:
            Method: delete
            Path: /apps/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: delete_app.delete
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - cloudformation:DeleteStack
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  DeletePipeline:
    Properties:
      CodeUri: s3://storage-kalleh/70d2c481c6ac5d6299d52c9a90e43b56
      Events:
        DeletePipeline:
          Properties:
            Method: delete
            Path: /pipelines/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: delete_pipeline.delete
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - cloudformation:DeleteStack
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  DeleteService:
    Properties:
      CodeUri: s3://storage-kalleh/72360e402a001470f5f7a75d53b6a75c
      Events:
        DeleteService:
          Properties:
            Method: delete
            Path: /services/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: delete_service.delete
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - cloudformation:DeleteStack
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  DependenciesLayerVersion:
    Properties:
      CompatibleRuntimes:
      - python3.6
      - python3.7
      ContentUri: s3://storage-kalleh/6513ca19c17dd9c3848d957157972001
      Description: Shared libraries across functions
      LayerName: shared_layer
    Type: AWS::Serverless::LayerVersion
  DeploymentRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - cloudformation.amazonaws.com
        Version: '2012-10-17'
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/PowerUserAccess
      - arn:aws:iam::aws:policy/IAMFullAccess
      Path: /
    Type: AWS::IAM::Role
  DescribeApp:
    Properties:
      CodeUri: s3://storage-kalleh/d96fc9727eca29d1b62c83ddca181793
      Events:
        DescribeApp:
          Properties:
            Method: get
            Path: /apps/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: describe_app.get
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  DescribeEvents:
    Properties:
      CodeUri: s3://storage-kalleh/28d90b38e6a006ec27f8278d540cd7a8
      Events:
        DescribeEvents:
          Properties:
            Method: get
            Path: /events/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: list_events.get
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - cloudformation:DescribeStackEvents
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  DescribePipeline:
    Properties:
      CodeUri: s3://storage-kalleh/70d2c481c6ac5d6299d52c9a90e43b56
      Events:
        DescribePipeline:
          Properties:
            Method: get
            Path: /pipelines/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: describe_pipeline.get
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  DescribePipelineState:
    Properties:
      CodeUri: s3://storage-kalleh/b6d7beb7ebad41a251e81f916c5fcf0b
      Events:
        DescribePipeline:
          Properties:
            Method: get
            Path: /pipelines/{name}/states
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: describe_pipeline_state.get
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - codepipeline:GetPipelineState
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  DescribeService:
    Properties:
      CodeUri: s3://storage-kalleh/72360e402a001470f5f7a75d53b6a75c
      Events:
        DescribeService:
          Properties:
            Method: get
            Path: /services/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: describe_service.get
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  IdentityPool:
    Properties:
      AllowUnauthenticatedIdentities: true
      CognitoIdentityProviders:
      - ClientId:
          Ref: UserPoolClient
        ProviderName:
          Fn::GetAtt:
          - UserPool
          - ProviderName
      IdentityPoolName:
        Fn::Sub: ${PlatformPrefix}_idp
    Type: AWS::Cognito::IdentityPool
  IdentityPoolRoleMapping:
    Properties:
      IdentityPoolId:
        Ref: IdentityPool
      Roles:
        authenticated:
          Fn::GetAtt:
          - CognitoAuthorizedRole
          - Arn
        unauthenticated:
          Fn::GetAtt:
          - CognitoUnAuthorizedRole
          - Arn
    Type: AWS::Cognito::IdentityPoolRoleAttachment
  ListApps:
    Properties:
      CodeUri: s3://storage-kalleh/0a8f0b2b02a69c880ef6678d0a03312f
      Events:
        ListApps:
          Properties:
            Method: get
            Path: /apps
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: list_apps.get
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  ListPipelines:
    Properties:
      CodeUri: s3://storage-kalleh/e0eb4ec602bd97df4a9ee8ed99c7a253
      Events:
        ListPipelines:
          Properties:
            Method: get
            Path: /pipelines
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: list_pipelines.get
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  ListServices:
    Properties:
      CodeUri: s3://storage-kalleh/2e341ea17ea92ece7e11f3787ce55b5d
      Events:
        ListServices:
          Properties:
            Method: get
            Path: /services
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: list_services.get
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  ProductsBucket:
    Properties:
      AccessControl: BucketOwnerFullControl
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
    Type: AWS::S3::Bucket
  ProductsBucketPolicy:
    Properties:
      Bucket:
        Ref: ProductsBucket
      PolicyDocument:
        Statement:
        - Action:
          - s3:GetObject
          - s3:List*
          Effect: Allow
          Principal:
            AWS:
            - Fn::GetAtt:
              - CreateAppRole
              - Arn
            - Fn::GetAtt:
              - UpdateAppRole
              - Arn
            - Fn::GetAtt:
              - CreatePipelineRole
              - Arn
            - Fn::GetAtt:
              - UpdatePipelineRole
              - Arn
            - Fn::GetAtt:
              - CreateServiceRole
              - Arn
            - Fn::GetAtt:
              - UpdateServiceRole
              - Arn
          Resource:
          - Fn::Sub: arn:aws:s3:::${ProductsBucket}/*
    Type: AWS::S3::BucketPolicy
  PutPipelineState:
    Properties:
      CodeUri: s3://storage-kalleh/b6d7beb7ebad41a251e81f916c5fcf0b
      Events:
        DescribePipeline:
          Properties:
            Method: put
            Path: /pipelines/{name}/states
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: put_pipeline_state.put
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - codepipeline:GetPipelineState
          - codepipeline:PutApprovalResult
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  UpdateApp:
    Properties:
      CodeUri: s3://storage-kalleh/d96fc9727eca29d1b62c83ddca181793
      Events:
        UpdateApp:
          Properties:
            Method: patch
            Path: /apps/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: update_app.patch
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - cloudformation:UpdateStack
          - cloudformation:ListExports
          - elasticloadbalancing:DescribeRules
          - iam:PassRole
          - ssm:GetParametersByPath
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  UpdatePipeline:
    Properties:
      CodeUri: s3://storage-kalleh/70d2c481c6ac5d6299d52c9a90e43b56
      Events:
        UpdatePipeline:
          Properties:
            Method: patch
            Path: /pipelines/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: update_pipeline.patch
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - cloudformation:UpdateStack
          - cloudformation:ListExports
          - iam:PassRole
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  UpdateService:
    Properties:
      CodeUri: s3://storage-kalleh/72360e402a001470f5f7a75d53b6a75c
      Events:
        UpdateService:
          Properties:
            Method: patch
            Path: /services/{name}
            RestApiId:
              Ref: ApiGatewayApi
          Type: Api
      Handler: update_service.patch
      Layers:
      - Ref: DependenciesLayerVersion
      - Ref: XRayLayerVersion
      MemorySize: 1024
      Policies:
      - Statement:
        - Action:
          - cloudformation:DescribeStacks
          - cloudformation:UpdateStack
          - iam:PassRole
          Effect: Allow
          Resource:
          - '*'
      Tracing: Active
    Type: AWS::Serverless::Function
  UserPool:
    Properties:
      AutoVerifiedAttributes:
      - email
      EmailVerificationSubject:
        Ref: AWS::StackName
      MfaConfiguration: 'OFF'
      UserPoolName:
        Fn::Sub: ${PlatformPrefix}_users
    Type: AWS::Cognito::UserPool
  UserPoolClient:
    Properties:
      ClientName:
        Fn::Sub: ${PlatformPrefix}-client
      GenerateSecret: false
      UserPoolId:
        Ref: UserPool
    Type: AWS::Cognito::UserPoolClient
  UserPoolGroup:
    Properties:
      Description: User pool group for Admin access
      GroupName:
        Fn::Sub: ${PlatformPrefix}_admin_group
      Precedence: 0
      UserPoolId:
        Ref: UserPool
    Type: AWS::Cognito::UserPoolGroup
  XRayLayerVersion:
    Properties:
      CompatibleRuntimes:
      - python3.6
      - python3.7
      ContentUri: s3://storage-kalleh/17c0e0005b59118dc5147b78a65b14e6
      Description: AWS X-Ray SDK for Python
      LayerName: xray_python_layer
    Type: AWS::Serverless::LayerVersion
Transform:
- AWS::Serverless-2016-10-31
