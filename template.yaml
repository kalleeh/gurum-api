AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: >
    'This SAM template creates the management API for the container platform.
    Last Modified: July 17th 2018
    Author: Karl Wallbom <wallbomk@amazon.com'

Parameters:

  # Email address for Cognito Admin user
  CognitoAdminEmail:
    Type: String
    Default: wallbomk@amazon.com
    AllowedPattern: '^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$'
    Description: E-mail address of the Cognito admin

  PlatformBucket:
    Description: S3 Bucket to get the product templates from
    Type: String
    Default: "storage-kalleh"

  PlatformRegion:
    Description: Region to deploy the platform resources in
    Type: String
    Default: "eu-west-1"

  PlatformPrefix:
    Description: String to use as prefix for platform resources
    Type: String
    Default: "gureume"

Globals:
  Function:
    Runtime: python3.6
    Timeout: 180
    Handler: index.handler
    Environment:
      Variables:
        PLATFORM_REGION: !Ref PlatformRegion
        PLATFORM_PREFIX: !Sub "${PlatformPrefix}-"
        PLATFORM_BUCKET: !Ref PlatformBucket
        PLATFORM_DEPLOYMENT_ROLE: !GetAtt DeploymentRole.Arn
  Api:
    EndpointConfiguration: REGIONAL

Resources:

  #
  # Cognito and IAM
  #
  # Creates a user pool in cognito to auth against
  UserPool:
    Type: 'AWS::Cognito::UserPool'
    Properties:
      UserPoolName: !Sub ${PlatformPrefix}_users
      AutoVerifiedAttributes:
        - email
      MfaConfiguration: 'OFF'
      EmailVerificationSubject: !Ref AWS::StackName

  # Creates a needed group in Cognito for Admin access
  UserPoolGroup:
    Type: "AWS::Cognito::UserPoolGroup"
    Properties:
      Description: 'User pool group for Admin access'
      GroupName: !Sub ${PlatformPrefix}_admin_group
      Precedence: 0
      UserPoolId: !Ref UserPool

  # Creates a User Pool Client to be used by the identity pool
  UserPoolClient:
    Type: 'AWS::Cognito::UserPoolClient'
    Properties:
      ClientName: !Sub ${PlatformPrefix}-client
      GenerateSecret: false
      UserPoolId: !Ref UserPool

  # Creates a federated Identity pool
  IdentityPool:
    Type: 'AWS::Cognito::IdentityPool'
    Properties:
      IdentityPoolName: !Sub ${PlatformPrefix}_idp
      AllowUnauthenticatedIdentities: true
      CognitoIdentityProviders:
        - ClientId: !Ref UserPoolClient
          ProviderName: !GetAtt UserPool.ProviderName

  # Create a role for unauthorized access to AWS resources. Very limited access.
  # Only allows users in the previously created Identity Pool
  CognitoUnAuthorizedRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Federated: 'cognito-identity.amazonaws.com'
            Action:
              - 'sts:AssumeRoleWithWebIdentity'
            Condition:
              StringEquals:
                'cognito-identity.amazonaws.com:aud': !Ref IdentityPool
              'ForAnyValue:StringLike':
                'cognito-identity.amazonaws.com:amr': unauthenticated
      Policies:
        - PolicyName: 'CognitoUnauthorizedPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 'mobileanalytics:PutEvents'
                  - 'cognito-sync:BulkPublish'
                  - 'cognito-sync:DescribeIdentityPoolUsage'
                  - 'cognito-sync:GetBulkPublishDetails'
                  - 'cognito-sync:GetCognitoEvents'
                  - 'cognito-sync:GetIdentityPoolConfiguration'
                  - 'cognito-sync:ListIdentityPoolUsage'
                  - 'cognito-sync:SetCognitoEvents'
                  - 'congito-sync:SetIdentityPoolConfiguration'
                Resource: !Sub 'arn:aws:cognito-identity:${AWS::Region}:${AWS::AccountId}:identitypool/${IdentityPool}'

  # Create a role for authorized access to AWS resources.
  # Only allows users in the previously created Identity Pool
  CognitoAuthorizedRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Federated: 'cognito-identity.amazonaws.com'
            Action:
              - 'sts:AssumeRoleWithWebIdentity'
            Condition:
              StringEquals:
                'cognito-identity.amazonaws.com:aud': !Ref IdentityPool
              'ForAnyValue:StringLike':
                'cognito-identity.amazonaws.com:amr': authenticated
      Policies:
        - PolicyName: 'CognitoAuthorizedPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 'mobileanalytics:PutEvents'
                  - 'cognito-sync:BulkPublish'
                  - 'cognito-sync:DescribeIdentityPoolUsage'
                  - 'cognito-sync:GetBulkPublishDetails'
                  - 'cognito-sync:GetCognitoEvents'
                  - 'cognito-sync:GetIdentityPoolConfiguration'
                  - 'cognito-sync:ListIdentityPoolUsage'
                  - 'cognito-sync:SetCognitoEvents'
                  - 'congito-sync:SetIdentityPoolConfiguration'
                  - 'cognito-identity:DeleteIdentityPool'
                  - 'cognito-identity:DescribeIdentityPool'
                  - 'cognito-identity:GetIdentityPoolRoles'
                  - 'cognito-identity:GetOpenIdTokenForDeveloperIdentity'
                  - 'cognito-identity:ListIdentities'
                  - 'cognito-identity:LookupDeveloperIdentity'
                  - 'cognito-identity:MergeDeveloperIdentities'
                  - 'cognito-identity:UnlikeDeveloperIdentity'
                  - 'cognito-identity:UpdateIdentityPool'
                Resource: !Sub 'arn:aws:cognito-identity:${AWS::Region}:${AWS::AccountId}:identitypool/${IdentityPool}'

  CognitoESAccessRole:
    Type: 'AWS::IAM::Role'
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonESCognitoAccess
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'es.amazonaws.com'
            Action:
              - 'sts:AssumeRole'

  # Assigns the roles to the Identity Pool
  IdentityPoolRoleMapping:
    Type: 'AWS::Cognito::IdentityPoolRoleAttachment'
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        authenticated: !GetAtt CognitoAuthorizedRole.Arn
        unauthenticated: !GetAtt CognitoUnAuthorizedRole.Arn

  AdminUser:
    Type: 'AWS::Cognito::UserPoolUser'
    Properties:
      DesiredDeliveryMediums:
        - 'EMAIL'
      UserAttributes:
        - Name: email
          Value: !Ref CognitoAdminEmail
      Username: !Ref CognitoAdminEmail
      UserPoolId: !Ref UserPool
  
  DeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement:
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "cloudformation.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
          - 
            Effect: "Allow"
            Principal: 
              AWS: 
                - !GetAtt CreateAppRole.Arn
                - !GetAtt CreatePipelineRole.Arn
            Action: 
              - "sts:AssumeRole"
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/PowerUserAccess
      - arn:aws:iam::aws:policy/IAMFullAccess

  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: v1
      DefinitionBody:
  # External swagger definition
  #      Fn::Transform:
  #        Name: AWS::Include
  #        Parameters:
  #          Location: s3://storage-kalleh/swagger/swagger.yaml
        swagger: "2.0"
        info:
          version: "1.0"
          title: "gureume-api"
        host: "api.gureu.me"
        schemes:
        - "https"
        paths:
          /apps:
            get:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ListApps.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            post:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
                - name: body
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/CreateAppRequest'
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateApp.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "body-json" : $input.json('$')
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /apps/{name}:
            get:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeApp.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            delete:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DeleteApp.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            patch:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpdateApp.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      },
                      "body-json" : $input.json('$')
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /events/{name}:
            get:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeEvents.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /pipelines:
            get:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ListPipelines.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            post:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
                - name: body
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/CreatePipelineRequest'
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreatePipeline.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "body-json" : $input.json('$')
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /pipelines/{name}:
            get:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribePipeline.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            post:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreatePipeline.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "body-json" : $input.json('$')
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            delete:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DeletePipeline.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            patch:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpdatePipeline.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      },
                      "body-json" : $input.json('$')
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /services:
            get:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ListServices.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            post:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
                - name: body
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/CreateServiceRequest'
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateService.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "body-json" : $input.json('$')
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /services/{name}:
            get:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeService.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            post:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateService.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "body-json" : $input.json('$')
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            delete:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DeleteService.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      }
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            patch:
              consumes:
              - "application/json"
              produces:
              - "application/json"
              parameters:
              - name: "name"
                in: "path"
                required: true
                type: "string"
              responses:
                '200':
                  description: "200 response"
                  schema:
                    $ref: "#/definitions/Empty"
              security:
              - CognitoUserPool: []
              x-amazon-apigateway-integration:
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpdateService.Arn}/invocations
                responses:
                  default:
                    statusCode: "200"
                requestTemplates:
                  application/json: |
                    #set($allParams = $input.params())
                    {
                      "claims" : {
                        "email" : "$context.authorizer.claims['email']",
                        "groups" : "$context.authorizer.claims['cognito:groups']"
                      },
                      "params" : {
                        "name" : "$input.params('name')"
                      },
                      "body-json" : $input.json('$')
                    }
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
        securityDefinitions:
          CognitoUserPool:
            in: header
            type: apiKey
            name: Authorization
            x-amazon-apigateway-authtype: cognito_user_pools
            x-amazon-apigateway-authorizer:
                type: cognito_user_pools
                providerARNs:
                    - !GetAtt UserPool.Arn
        definitions:
          Empty:
            type: "object"
            title: "Empty Schema"
          CreateAppRequest:
            type: object
            properties:
              name:
                type: string
              tasks:
                type: int
              health_check_path:
                type: string
              image:
                type: string
            required:
              - name
              - tasks
              - health_check_path
          CreatePipelineRequest:
            type: object
            properties:
              name:
                type: string
              app_name:
                type: string
              app_dev:
                type: string
              app_test:
                type: string
              github_repo:
                type: string
              github_branch:
                type: string
              github_token:
                type: string
              github_user:
                type: string
            required:
              - name
              - app_name
              - github_repo
              - github_branch
              - github_token
              - github_user
          CreateServiceRequest:
            type: object
            properties:
              name:
                type: string
              service_type:
                type: string
              image:
                type: string
            required:
              - name
        x-amazon-apigateway-binary-media-types:
        - "application/octet-stream"
        - "application/x-tar"
        - "application/zip"
        - "audio/basic"
        - "audio/ogg"
        - "audio/mp4"
        - "audio/mpeg"
        - "audio/wav"
        - "audio/webm"
        - "image/png"
        - "image/jpg"
        - "image/jpeg"
        - "image/gif"
        - "video/ogg"
        - "video/mpeg"
        - "video/webm"

  # Apps definition
  ListApps:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: apps.get
      CodeUri: src/
      Tracing: "Active"
      Events:
        ListApps:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /apps
            Method: get
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
              Resource:
                - '*'

  CreateApp:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: apps.post
      CodeUri: src/
      Tracing: "Active"
      Events:
        CreateApp:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /apps
            Method: post
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:CreateStack'
                - 'cloudformation:ListExports'
                - 'elasticloadbalancing:DescribeRules'
                - 'iam:PassRole'
              Resource:
                - '*'

  DescribeApp:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: apps_name.get
      CodeUri: src/
      Tracing: "Active"
      Events:
        DescribeApp:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /apps/{name}
            Method: get
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
              Resource:
                - '*'

  DeleteApp:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: apps_name.delete
      CodeUri: src/
      Tracing: "Active"
      Events:
        DeleteApp:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /apps/{name}
            Method: delete
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
                - 'cloudformation:DeleteStack'
              Resource:
                - '*'

  UpdateApp:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: apps_name.patch
      CodeUri: src/
      Tracing: "Active"
      Events:
        UpdateApp:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /apps/{name}
            Method: patch
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
                - 'cloudformation:UpdateStack'
                - 'iam:PassRole'
              Resource:
                - '*'

# Events definition
  DescribeEvents:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: events_name.get
      CodeUri: src/
      Tracing: "Active"
      Events:
        DescribeEvents:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /events/{name}
            Method: get
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
                - 'cloudformation:DescribeStackEvents'
              Resource:
                - '*'
  
  # Pipelines definition
  ListPipelines:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: pipelines.get
      CodeUri: src/
      Tracing: "Active"
      Events:
        ListPipelines:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /pipelines
            Method: get
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
              Resource:
                - '*'

  CreatePipeline:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: pipelines.post
      CodeUri: src/
      Tracing: "Active"
      Events:
        CreatePipeline:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /pipelines
            Method: post
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:CreateStack'
                - 'cloudformation:ListExports'
                - 'iam:PassRole'
              Resource:
                - '*'

  DescribePipeline:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: pipelines_name.get
      CodeUri: src/
      Tracing: "Active"
      Events:
        DescribePipeline:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /pipelines/{name}
            Method: get
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
              Resource:
                - '*'

  DeletePipeline:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: pipelines_name.delete
      CodeUri: src/
      Tracing: "Active"
      Events:
        DeletePipeline:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /pipelines/{name}
            Method: delete
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
                - 'cloudformation:DeleteStack'
              Resource:
                - '*'

  UpdatePipeline:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: pipelines_name.patch
      CodeUri: src/
      Tracing: "Active"
      Events:
        UpdatePipeline:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /pipelines/{name}
            Method: patch
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
                - 'cloudformation:UpdateStack'
                - 'iam:PassRole'
              Resource:
                - '*'

# Services definition
  ListServices:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: services.get
      CodeUri: src/
      Tracing: "Active"
      Events:
        ListServices:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /services
            Method: get
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
              Resource:
                - '*'

  CreateService:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: services.post
      CodeUri: src/
      Tracing: "Active"
      Events:
        CreateService:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /services
            Method: post
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:CreateStack'
                - 'cloudformation:ListExports'
                - 'iam:PassRole'
              Resource:
                - '*'

  DescribeService:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: services_name.get
      CodeUri: src/
      Tracing: "Active"
      Events:
        DescribeService:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /services/{name}
            Method: get
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
              Resource:
                - '*'

  DeleteService:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: services_name.delete
      CodeUri: src/
      Tracing: "Active"
      Events:
        DeleteService:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /services/{name}
            Method: delete
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
                - 'cloudformation:DeleteStack'
              Resource:
                - '*'

  UpdateService:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: services_name.patch
      CodeUri: src/
      Tracing: "Active"
      Events:
        UpdateService:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /services/{name}
            Method: patch
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - 'cloudformation:DescribeStacks'
                - 'cloudformation:UpdateStack'
                - 'iam:PassRole'
              Resource:
                - '*'

Outputs:

    CognitoUserPoolID:
      Description: Cognito User Pool ID to be used by clients
      Value: !Ref UserPool

    CognitoUserPoolClientID:
      Description: Cognito User Pool Client ID to be used by clients
      Value: !Ref UserPoolClient

    CognitoIdentityPoolID:
      Description: Cognito Identity Pool ID to be used by clients
      Value: !Ref IdentityPool